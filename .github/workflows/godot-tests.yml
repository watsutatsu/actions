name: Godot Tests

on:
  workflow_call:
    inputs:
      godot_version:
        description: Godot version to use when building the project'
        required: true
        default: 4.2.2
        type: string

      gut_version:
        description: GUT version to use when running tests
        required: true
        default: 9.2.1
        type: string

      project_path:
        description: Path to the project
        required: true
        default: games/test-project
        type: string
       
jobs:
  godot-tests:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.2.2
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
      - name: Setup GUT
        run: |
          GUT_VERION=${{ inputs.GUT_VERSION }}
          wget https://github.com/bitwes/Gut/archive/refs/tags/v${GUT_VERION}.zip
          unzip v${GUT_VERION}.zip
          mv Gut-${GUT_VERION}/addons ./
          rm -rf Gut-${GUT_VERION}

          find -type f # DEBUG
      - name: Run Tests
        run: |
          # HACK - See https://github.com/watsutatsu/godot-samples/issues/3#issuecomment-2119308212
          timeout 30s godot --headless --import-stuff --editor --path "$PWD" 
          godot --headless --verbose --export-release "HTML5" build/web/index.html